{"data":{"site":{"siteMetadata":{"title":"Ramblings about technology, cloud & automation","author":"Alex Dobjanschi"}},"markdownRemark":{"id":"2010fe71-bb20-58b9-b1e9-d9675d00857b","excerpt":"As part of the  AWS Labs  series, this blog post describes a simple, easy to implement and cost-effective service that allows users to…","html":"<blockquote>\n<p>As part of the <strong>AWS Labs</strong> series, this blog post describes a simple, easy to implement and cost-effective service that allows users to submit text and listen back to a converted sound file (.mp3)</p>\n</blockquote>\n<p><a href=\"https://aws.amazon.com/polly/\">Polly</a> is a <a href=\"https://aws.amazon.com/about-aws/whats-new/2016/11/introducing-amazon-polly/\">recently introduced</a> managed AWS service that performs text-to-speech. While new, it already supports dozens of voices (over 50!) and, like other AWS services, the interaction is managed through language-specific bindings/client (the famous <a href=\"https://aws.amazon.com/getting-started/tools-sdks\">AWS SDK</a>)</p>\n<blockquote>\n<p>See this in action <a href=\"http://labs.alexdobjanschi.me/text-to-audio/\">demo</a>\n(<small>Drop me a PM for API access key</small>)</p>\n</blockquote>\n<blockquote>\n<p>Grab the source code <a href=\"https://github.com/djalexd/aws-labs-text-to-audio\">here</a></p>\n</blockquote>\n<h3>Getting started</h3>\n<p>As already mentioned, this post is proof of concept for <a href=\"https://aws.amazon.com/polly/\">Polly</a>, “wrapped” with a couple of other components that make the whole flow simpler:</p>\n<ul>\n<li>basic UI to interact with</li>\n<li>posts persistence using DynamoDB</li>\n<li>API that <em>creates a post</em> (POST) and <em>lists all posts</em> (GET)</li>\n<li>backend processor that gets notified via <a href=\"https://aws.amazon.com/sns\">SNS</a></li>\n</ul>\n<p>The solution diagram is the following:</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f3251c432cb662d589ee60268066f01b/e7194/text-to-audio-architecture.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 74.07821229050279%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAAC20lEQVQ4y2M4e+6c8IuXL1kYoOB/VwHjdX8HRhh/Z5cZ45Xpvqwg9s85EUU/F8TPBrHVfLKZDMNqWf3a94PVanpmQjQADZx64OBBaxDb2syMHW6woTdDX7EW3GAQeDUtqvXF1MhtDGjg////CM6x48d19+7dKwzjL7LWt9vhbGYE42/pMlXd3GnqExJiBnIlLxDzg8RF7dJEtWP7apxLliqB+Nq++UxgDefOn489c/KkAoidqavOe8jD+u1OV4srTBoMYG+ubTXt3TXB8tu5uXZSYAv+/wdrFLSMdzEpXPMfaGAyiC+m5cDFzgqUOnX6dPmePXuMwaZ7hjAusDdNXeFoFg5z4cQCHdtFtYb5Xg5y3EAuMxCDLRI0i+HVimhNFil4xAcOU01NdjcPb0Zs4cAJ1ciwotkIJax+zons+Do3bi+ILSvJBTZ4U5Oq6snZ1oaIgH79mvH4sWNwfpaWMuv/6nRGhEX5DP+Pp4FTwdOJYXlPJoROBzIZBUQlgRHowrq5y+zohYWOLydNnsZz8NgFToat27YxbNy0iYGJEWIGJwcHa052NjPMxUycXJgxCeK/PArWsL6SU/rivglhZ86en37x4oVmBiyAhQEHOBlgL3zCz04OXbxcU5y3t7dHcMfOXVxwwcWLF4PpqVOncp05c8Z5xowZQiAHKoiLsWnw84DD64iH9Q5gCngPDGSuc2dPWa489Vjxdaejx4+FiX+v5ynrodjy8OFDMP3582fG8+fP80+bNg3sUi0pCcYCPXWw93a6W+VucbOaCArD21fOC174/59tR5aR5pm24Olb82ykMLz05MkTBjwAZCgfFDNjUzB/2hxEsjl06BCY3r9/P8O5c+cYpk+fDuZ7aaiiJC0Ivstgk9EHTuCKvpWWqmFtazQSZqgykAqUeLgYdAR4wWzdxKlgV+okTs21rNj+37hgnRcDJSD+ECQZCamaS2uGNXnImPkLgvgATkMBlwm8oLcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"text to audio AWS architecture\"\n        title=\"\"\n        src=\"/static/f3251c432cb662d589ee60268066f01b/fb8a0/text-to-audio-architecture.png\"\n        srcset=\"/static/f3251c432cb662d589ee60268066f01b/1a291/text-to-audio-architecture.png 148w,\n/static/f3251c432cb662d589ee60268066f01b/2bc4a/text-to-audio-architecture.png 295w,\n/static/f3251c432cb662d589ee60268066f01b/fb8a0/text-to-audio-architecture.png 590w,\n/static/f3251c432cb662d589ee60268066f01b/526de/text-to-audio-architecture.png 885w,\n/static/f3251c432cb662d589ee60268066f01b/e7194/text-to-audio-architecture.png 895w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h3>Implementation details</h3>\n<p>There are a couple of things happening in this diagram:</p>\n<ol>\n<li>Users visit the site address, which in turn load static contents from an S3 bucket. The bucket is configured to <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html\">host a static website</a></li>\n<li>The Javascript client communicates with an API gateway (to retrieve all available posts or to publish a new one)</li>\n<li>API gateway has a single endpoint <code class=\"language-text\">/text-to-audio</code> with 2 methods: <code class=\"language-text\">GET</code> (retrieve posts) and <code class=\"language-text\">POST</code> (submit a new post). Both methods are configured to invoke lambda functions that interact with a single DynamoDB table.</li>\n</ol>\n<blockquote>\n<p>Since process (text-to-speech conversion) can take more than than API gateway timeout (<em>29 seconds</em>), it’ advisable  to decouple frontend-related functionality from long-running tasks. Particularly here, create new posts &#x26; converting text-to-speech</p>\n</blockquote>\n<ol start=\"4\">\n<li>All these messages are sent via SNS topic to an offline processor (lambda function). This is the moment when <a href=\"https://aws.amazon.com/polly/\">Polly</a> is called. The function actually performs slightly more than it should: convert, stream result body to S3 and update item in database. But alas, this is a demo! (<small><em>hint: use step functions</em></small>)</li>\n</ol>\n<h3>Final thoughts</h3>\n<p>This was a super fun lab where besides text-to-speech via Polly, I got to practice with ReactJS (barebones, no Redux). All the AWS resources are managed with Terraform code, so I don’t really have <em>to ever manually go into AWS account and configure anything</em>!</p>\n<p>But, because this is merely a lab/demo, I simplified a couple of aspects:\n<small></p>\n<ul>\n<li>by far this is not a production environment: static website contents, as well as generated .mp3 files are <em>publicly accessible</em> without any authentication or credentials!</li>\n<li>API gateway security is achieved using <em>api key</em> and while it’s easy to add more keys (e.g. one key per consumer), it also doesn’t scale beyond a handful of items. This is by far the easiest method to secure API access.</li>\n<li><em>No unit tests or integration tests!</em></li>\n<li>No CI/CD pipelines.</li>\n<li>Everything is provisioned through <em>Terraform</em>, but some resources’ lifecycle should be decoupled (e.g. UI static resources should not be deployed every time - unwanted side-effect because a <a href=\"https://www.terraform.io/docs/provisioners/null_resource.html\"><em>null_resource</em></a> is used)</li>\n</ul>\n</small>\n<h3>Gotchas</h3>\n<ul>\n<li>\n<p>I particularly struggled with API Gateway CORS configuration, so be extra careful there! Perhaps a different integration method could be possible, but <code class=\"language-text\">AWS_PROXY</code> simply returns whatever is configured with lambda response. UI finally worked when I added <code class=\"language-text\">Access-Control-Allow-Origin</code> header in lambda response, as seen <a href=\"https://github.com/djalexd/aws-labs-text-to-audio/blob/master/functions/http.py#L8\">here</a></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">'statusCode'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'body'</span><span class=\"token punctuation\">:</span> payload<span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'headers'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'Access-Control-Allow-Origin'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'*'</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>Getting IAM roles is time consuming, but rewarding on the long-run (e.g. API gateway lambda invocation, lambda execution). <em>Make sure your roles allow enough permissions for necessary functionality, but nothing more!</em></li>\n<li><em>Always write unit tests!</em> If for no better reason (code coverage, code complexity, static code analysis, BDD, etc etc etc), it simply felt that uploading &#x26; manually testing functionality is too slow. I estimated to have lost about 3 hours of debugging (compile, zip, upload, test … repeat) on simple things like undefined variables, wrong number of parameters, etc. Linting would also help a lot!</li>\n</ul>\n<p>I hope you enjoyed this lab! See you next time!</p>","frontmatter":{"title":"AWS Labs - text to audio","date":"November 25, 2018"}}},"pageContext":{"slug":"/aws-lab-text-to-audio/","previous":{"fields":{"slug":"/hello-world/"},"frontmatter":{"title":"Hello World"}},"next":null}}